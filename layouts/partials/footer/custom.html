<!-- 开场页脚本 -->
<script>
  (function() {
    // 检查是否是首页
    const isHomePage = window.location.pathname === '/' || window.location.pathname === '/index.html';
    const hasSeenSplash = sessionStorage.getItem('splashShown');
    
    if (!isHomePage || hasSeenSplash) {
      return;
    }

    const splashImageUrl = '/splash.png';
    const LOADING_TIMEOUT = 5000; // 5秒超时
    const MIN_DISPLAY_TIME = 2500; // 至少显示2.5秒

    // 预加载图片
    const preloadImage = new Image();
    let imageLoaded = false;
    let hasTimedOut = false;

    // 超时保护：如果5秒内图片未加载完成，直接跳过开场页
    const timeout = setTimeout(function() {
      if (!imageLoaded) {
        hasTimedOut = true;
        console.warn('开场图片加载超时，跳过开场页');
        sessionStorage.setItem('splashShown', 'true');
        document.documentElement.classList.remove('splash-init');
      }
    }, LOADING_TIMEOUT);

    preloadImage.onload = function() {
      imageLoaded = true;
      clearTimeout(timeout);
      
      // 如果已经超时，不再显示开场页
      if (hasTimedOut) {
        console.log('图片加载完成但已超时，跳过开场页');
        return;
      }
      
      // 标记已显示（防止重复显示）
      sessionStorage.setItem('splashShown', 'true');

      // 移除占位层样式
      document.documentElement.classList.remove('splash-init');
      document.body.classList.add('splash-loading');
      
      const splashScreen = document.createElement('div');
      splashScreen.id = 'splash-screen';
      splashScreen.style.setProperty('--splash-bg-image', 'url(' + splashImageUrl + ')');

      const splashContent = document.createElement('div');
      splashContent.className = 'splash-content';

      const splashImage = document.createElement('img');
      splashImage.id = 'splash-image';
      splashImage.src = splashImageUrl;
      splashImage.alt = 'Welcome';

      const splashText = document.createElement('div');
      splashText.className = 'splash-text';

      const splashTitle = document.createElement('h1');
      splashTitle.className = 'splash-title';
      splashTitle.textContent = 'ShaddockNH3';

      const splashSubtitle = document.createElement('p');
      splashSubtitle.className = 'splash-subtitle';
      splashSubtitle.textContent = '技术、文学与哲学的交汇之地';

      splashText.appendChild(splashTitle);
      splashText.appendChild(splashSubtitle);
      
      splashContent.appendChild(splashImage);
      splashContent.appendChild(splashText);
      splashScreen.appendChild(splashContent);
      
      document.body.insertBefore(splashScreen, document.body.firstChild);

      // 至少显示MIN_DISPLAY_TIME毫秒后开始淡出
      setTimeout(function() {
        splashScreen.classList.add('fade-out');
        document.body.classList.remove('splash-loading');
        
        // 淡出动画完成后移除元素
        setTimeout(function() {
          splashScreen.remove();
        }, 1000);
      }, MIN_DISPLAY_TIME);
    };

    preloadImage.onerror = function() {
      clearTimeout(timeout);
      console.error('开场图片加载失败，跳过开场页');
      sessionStorage.setItem('splashShown', 'true');
      document.documentElement.classList.remove('splash-init');
    };

    // 开始预加载
    preloadImage.src = splashImageUrl;
  })();
</script>
